{"version":3,"sources":["../scripts.babel/background.js"],"names":[],"mappings":"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","file":"background.js","sourcesContent":["'use strict';\n\n// TODO: Use local storage to gather historical data\n\n// traffic data for current session per tab\nvar trafficData = {};\nvar persistentData = JSON.parse(localStorage.getItem('ECNUD')) || {}; \nif(!persistentData.total){\n\tpersistentData.total = {};\n}\n\nvar co2ConversionRate = 7.22;\nvar pushIntervalTime = 500;\nvar bytesToPush = 0;\n\nfunction bytesToCO2(bytes){\n\treturn Math.round(bytes / 1024 / 1024 * co2ConversionRate);\n}\n\nfunction gramsToLiters(grams){\n\treturn Math.round(grams * (559 / 1000) * 1000) / 1000;\n}\n\n\n// CO2/Traffic Conversion: 1 MB / 0.722g CO2\n\nchrome.runtime.onInstalled.addListener(details => {\n  console.log('previousVersion', details.previousVersion);\n});\n\nchrome.webRequest.onHeadersReceived.addListener(\nfunction(details) {\n\tif(typeof trafficData[details.tabId] === 'undefined'){\n\t\ttrafficData[details.tabId] = 0;\n\t}\n\tvar contentLength = 0;\n\n\tfor (var i = 0; i < details.responseHeaders.length; ++i) {\n      if (details.responseHeaders[i].name.toLowerCase() === 'content-length') {\n      \tcontentLength = parseInt(details.responseHeaders[i].value, 10);\n      \tbreak;\n      }\n    }\n\n    trafficData[details.tabId] += contentLength;\n    bytesToPush += contentLength;\n\n    // Update historic data\n    if(details.tabId >= 0){\n\t\tchrome.tabs.get(details.tabId, function(tab){\n\t\t\tif(!tab || chrome.runtime.lastError) { return; }\n\t    \tvar currentTab = tab;\n\t    \tvar domain = currentTab.url.match(/^[\\w-]+:\\/*\\[?([\\w\\.:-]+)\\]?(?::\\d+)?/)[1].replace('www.', '');\n\t    \tif(typeof persistentData.total[domain] === 'undefined'){\n\t    \t\tpersistentData.total[domain] = 0;\n\t    \t}\n\t    \tpersistentData.total[domain] += contentLength;\n\t    });\n\t}\n},\n{urls: ['<all_urls>']},\n['responseHeaders']);\n\nchrome.windows.onRemoved.addListener(function(){\n\tlocalStorage.setItem('ECNUD', JSON.stringify(persistentData));\n});\n\nvar pushing = false;\nsetInterval(function(){\n\tif(gramsToLiters( bytesToCO2(bytesToPush) ) > 0 && !pushing) {\n\t\tpushing = true;\n\t\tvar temp = bytesToPush;\n\t\tbytesToPush = 0;\n\t\tconsole.log('Pushing', temp, gramsToLiters( bytesToCO2(temp) ));\n\t\tfetchival('http://10.211.55.13:3000/pushVolume?bytes=' + temp, { responseAs: 'text' })\n\t\t\t.get()\n  \t\t\t.catch(function(err) {\n\t\t\t\tconsole.log(err);\n\t\t\t});\n\t\tpushing = false;\n\t}\n}, pushIntervalTime);\n"]}